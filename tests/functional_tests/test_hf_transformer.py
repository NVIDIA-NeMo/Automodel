import subprocess


class TestHFTransformer:
    def test_hf_transformer_sft(self):
        subprocess.run(
            [
                "coverage",
                "run",
                "--data-file=/workspace/.coverage",
                "--source=/workspace/",
                "--parallel-mode",
                "recipes/llm/finetune.py",
                "--config",
                "recipes/llm/llama_3_2_1b_squad.yaml",
                "--model.pretrained_model_name_or_path",
                "/home/TestData/akoumparouli/hf_mixtral_2l/",
                "--step_scheduler.max_steps",
                "3",
                "--step_scheduler.grad_acc_steps",
                "1",
                "--dataset.tokenizer.pretrained_model_name_or_path",
                "/home/TestData/akoumparouli/hf_mixtral_2l/",
                "--validation_dataset.tokenizer.pretrained_model_name_or_path",
                "/home/TestData/akoumparouli/hf_mixtral_2l/",
                "--dataset.dataset_name",
                "/home/TestData/lite/hf_cache/squad/",
                "--dataset.limit_dataset_samples",
                "10",
            ],
            check=True,
        )

    def test_hf_transformer_peft(self):
        subprocess.run(
            [
                "coverage",
                "run",
                "--data-file=/workspace/.coverage",
                "--source=/workspace/",
                "--parallel-mode",
                "recipes/llm/finetune.py",
                "--config",
                "recipes/llm/llama_3_2_1b_squad.yaml",
                "--model.pretrained_model_name_or_path",
                "/home/TestData/akoumparouli/hf_mixtral_2l/",
                "--step_scheduler.max_steps",
                "3",
                "--step_scheduler.grad_acc_steps",
                "1",
                "--dataset.tokenizer.pretrained_model_name_or_path",
                "/home/TestData/akoumparouli/hf_mixtral_2l/",
                "--validation_dataset.tokenizer.pretrained_model_name_or_path",
                "/home/TestData/akoumparouli/hf_mixtral_2l/",
                "--step_scheduler.max_steps",
                "3",
                "--step_scheduler.grad_acc_steps",
                "1",
                "--dataset.tokenizer.pretrained_model_name_or_path",
                "/home/TestData/akoumparouli/hf_mixtral_2l/",
                "--validation_dataset.tokenizer.pretrained_model_name_or_path",
                "/home/TestData/akoumparouli/hf_mixtral_2l/",
                "--dataset.dataset_name",
                "/home/TestData/lite/hf_cache/squad/",
                "--dataset.limit_dataset_samples",
                "10",
                "--peft.peft_fn",
                "nemo_automodel._peft.lora.apply_lora_to_linear_modules",
                "--peft.target_modules",
                "*_proj",
                "--peft.dim",
                "16",
                "--peft.alpha",
                "32",
            ],
            check=True,
        )

    def test_hf_transformer_packed_sequence(self):
        subprocess.run(
            [
                "coverage",
                "run",
                "--data-file=/workspace/.coverage",
                "--source=/workspace/",
                "--parallel-mode",
                "recipes/llm/finetune.py",
                "--config",
                "recipes/llm/llama_3_2_1b_squad.yaml",
                "--model.pretrained_model_name_or_path",
                "/home/TestData/akoumparouli/hf_mixtral_2l/",
                "--step_scheduler.max_steps",
                "3",
                "--step_scheduler.grad_acc_steps",
                "2",
                "--dataset.tokenizer.pretrained_model_name_or_path",
                "/home/TestData/akoumparouli/hf_mixtral_2l/",
                "--packed_sequence.packed_sequence_size",
                "2048",
                "--dataloader.batch_size",
                "2",
                "--validation_dataset.tokenizer.pretrained_model_name_or_path",
                "/home/TestData/akoumparouli/hf_mixtral_2l/",
                "--dataset.dataset_name",
                "/home/TestData/lite/hf_cache/squad/",
                "--dataset.limit_dataset_samples",
                "100",
            ],
            check=True,
        )
