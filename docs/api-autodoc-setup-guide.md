# API Documentation Setup with Autodoc2

This guide captures the setup and management of autogenerated API documentation using autodoc2 in the NeMo Automodel project.

## Overview

The API documentation system uses autodoc2 to automatically generate comprehensive API reference documentation from Python docstrings, organized with a visual landing page and detailed module pages.

## Key Components

### 1. Autodoc2 Configuration (`docs/conf.py`)

```python
# Conditional autodoc2 configuration - only enable if packages exist
autodoc2_packages_list = [
    "../nemo_automodel/components/_peft",         # Parameter-efficient fine-tuning (LoRA)
    "../nemo_automodel/components/_transformers", # Model wrappers and utilities
    "../nemo_automodel/components/checkpoint",    # Checkpointing functionality
    "../nemo_automodel/components/config",        # Configuration loading
    "../nemo_automodel/components/datasets",      # Dataset loaders (llm/, vlm/)
    "../nemo_automodel/components/distributed",   # Distributed training strategies
    "../nemo_automodel/components/launcher",      # Job launchers (Slurm)
    "../nemo_automodel/components/loggers",       # Logging utilities
    "../nemo_automodel/components/loss",          # Loss functions
    "../nemo_automodel/components/optim",         # Optimizers and schedulers
    "../nemo_automodel/components/quantization",  # Model quantization
    "../nemo_automodel/components/training",      # Training utilities
    "../nemo_automodel/components/utils",         # General utilities
]

autodoc2_render_plugin = "myst"  # Use MyST for rendering docstrings
autodoc2_output_dir = "api-docs"  # Output directory for autodoc2 (relative to docs/)
```

### 2. Template System (`docs/_templates/autodoc2_index.rst`)

**CRITICAL:** Autodoc2 automatically regenerates `docs/api-docs/index.rst` from this template. Manual edits to the generated file will be overwritten.

**Template Format Requirements:**
- Use proper RST format for toctree: `.. toctree::`
- Include all module paths in the toctree
- Use {{ product_name }} for dynamic product name substitution
- Structure with visual grid cards and hidden toctree

### 3. File Structure

```
docs/
├── api-docs/                   # Autodoc2 output directory
│   ├── index.rst              # Generated from template (DO NOT EDIT DIRECTLY)
│   ├── _transformers/
│   │   ├── _transformers.md   # Main module file
│   │   └── *.md              # Individual class/function files
│   ├── datasets/
│   │   ├── datasets.md       # Main module file
│   │   └── *.md              # Individual class/function files
│   └── [other modules]/
└── _templates/
    └── autodoc2_index.rst     # Template source (EDIT THIS)
```

## Navigation Integration

### Main Table of Contents (`docs/index.md`)

Include both the landing page and individual modules in the References toctree:

```markdown
::::{toctree}
:hidden:
:caption: References
:maxdepth: 2
references/index
api-docs/index
api-docs/_transformers/_transformers
api-docs/datasets/datasets
api-docs/distributed/distributed
api-docs/_peft/_peft
api-docs/loss/loss
api-docs/training/training
api-docs/optim/optim
api-docs/checkpoint/checkpoint
api-docs/config/config
api-docs/launcher/launcher
api-docs/loggers/loggers
api-docs/quantization/quantization
api-docs/utils/utils
::::
```

**Path Format:** Use `module-directory/module-name` (e.g., `datasets/datasets`) to point to the main module file.

### References Landing Page (`docs/references/index.md`)

Add API Documentation card to the references grid:

```markdown
:::{grid-item-card} {octicon}`package;1.5em;sd-mr-1` API Documentation
:link: ../api-docs/index
:link-type: doc
:link-alt: Complete API documentation

Comprehensive autogenerated API documentation for all NeMo Automodel components.
+++
{bdg-primary}`API` {bdg-secondary}`Components`
:::
```

## Troubleshooting

### Issue: Manual edits to `docs/api-docs/index.rst` keep reverting

**Root Cause:** Autodoc2 regenerates this file from `docs/_templates/autodoc2_index.rst`

**Solution:** Edit the template file instead:
1. Modify `docs/_templates/autodoc2_index.rst`
2. Use proper RST format for toctree (not MyST)
3. Regenerate documentation to apply changes

### Issue: API modules not appearing in main navigation

**Root Cause:** Incorrect file paths in main toctree

**Solution:** Use correct module file paths:
- Correct: `api-docs/datasets/datasets` (points to `datasets.md`)
- Incorrect: `api-docs/datasets` (directory has no index file)

### Issue: RST format keeps converting to MyST

**Root Cause:** Template uses MyST format which gets propagated to generated files

**Solution:** Ensure template uses proper RST syntax:
```rst
.. toctree::
   :maxdepth: 1
   :caption: API Modules
   :hidden:

   _transformers
   datasets
   [other modules]
```

## Template Structure

### Header Section
- Use RST title format with underline
- Include product description with {{ product_name }} variable
- Provide context about API reference purpose

### Grid Layout
- Use `.. grid::` directive for visual organization
- Include 12+ component cards with:
  - Octicon icons for visual appeal
  - Descriptive titles and descriptions
  - Relevant badges for technologies/features
  - Proper link paths to module files

### Toctree Section
- Use RST format: `.. toctree::`
- Include `:hidden:` to keep clean navigation
- List all modules that should appear in navigation
- Use simple module names (autodoc2 handles full paths)

## Best Practices

1. **Always edit the template, never the generated file**
2. **Use consistent RST formatting throughout**
3. **Test navigation after template changes**
4. **Keep module list in sync between template and main navigation**
5. **Use descriptive badges and icons for visual organization**
6. **Verify all link paths point to actual files**

## Validation

After making changes, verify:
- [ ] API Reference appears in References section navigation
- [ ] Individual modules appear in References navigation  
- [ ] Visual grid cards work on API landing page
- [ ] All module links resolve correctly
- [ ] Template changes persist after autodoc2 regeneration

## Key Learnings

1. **Autodoc2 template system** automatically regenerates files - always edit templates, not generated files
2. **File path structure** matters for navigation - use `module-directory/module-name` format
3. **RST vs MyST format** - ensure consistent format to prevent auto-conversion issues
4. **Security restrictions** may prevent writing to `.cursor/rules` directory
5. **Navigation integration** requires both landing page and individual module entries in main toctree
